<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }
        .main {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        .main-top {
            width: 100%;
            height: 36vh;
            background-color: rgb(60 129 228);
        }
        .main-top .main-top-title {
            width: 960px;
            height: 80%;
            margin: 0 auto;
            color: #ffffff;
            opacity: 0.05;
            font-size: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-bottom {
            width: 100%;
            height: 64vh;
            background-color: rgb(246 246 246);
        }
        .main-bottom .main-bottom-copyright {
            position: absolute;
            bottom: 10px;
            width: 700px;
            text-align: center;
            left: 50%;
            font-size: 12px;
            color: #adadad;
            transform: translateX(-50%);
        }
        .main-content {
            width: 560px;
            background-color: #ffffff;
            position: absolute;
            left: 50%;
            top: 25vh;
            transform: translateX(-50%);
            border-radius: 6px;
            padding: 24px 0;
            box-shadow: 0 0 16px 0 rgba(204, 204, 204, 0.6);
        }
        .main-content-title {
            position: absolute;
            top: -60px;
            width: 100%;
            height: 60px;
            color: #ffffff;
            box-sizing: border-box;
            padding: 0 16px;

            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .main-content-title .title {
            font-size: 32px;
            height: 100%;
            display: flex;
            align-items: center;
        }
        .main-content-title .subtitle {
            font-size: 16px;
            height: 100%;
            display: flex;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .main-content-client {
            margin: 0 auto;
        }
        .main-content-client .ico {
            margin: 0 auto;
            width: 80px;
            height: 80px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid #aaaaaa;
            background-color: #3C81E4;
            background-size: 100% 100%;
        }
        .main-content-client .name {
            font-size: 24px;
            color: #262626;
            margin: 16px auto 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-content-input {
            width: 400px;
            margin: 20px auto;
            padding-bottom: 4px;
            border-bottom: 2px solid #262626;
        }
        .main-content-input label {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 36px;
            font-size: 22px;
            color: #262626;
        }
        .main-content-input input {
            width: 100%;
            height: 32px;
            font-size: 18px;
            border: none;
            outline: none;
            padding: 0 2px;
            color: #262626;
            margin-top: 6px;
        }
        .main-content-error {
            color: red;
            width: 400px;
            height: 20px;
            margin: 0 auto;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .main-content-button, .main-content-authorization {
            width: 400px;
            height: 48px;
            margin: 20px auto;
        }
        .main-content-button button {
            width: 100%;
            height: 100%;
            cursor: pointer;
            outline: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            border-radius: 4px;
            background: #3C81E4;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .main-content-authorization button {
            width: 100%;
            height: 100%;
            cursor: pointer;
            outline: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            border-radius: 4px;
            background: #3C81E4;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
    <!-- JQ -->
    <script type="text/javascript" src="./js/jsquery-2.1.1.js"></script>
    <!-- RSA -->
    <script src="./js/jssencrypt.js"></script>
</head>
<body>
<div class="main">
    <div id="prompt" style="padding: 20px; font-size: 20px; display: none;"></div>
    <div id="login" style="display: none;">
        <!-- 上部的内容 -->
        <div class="main-top">
            <p class="main-top-title">P6e Oauth2</p>
        </div>
        <!-- 下部的内容 -->
        <div class="main-bottom">
            <p class="main-bottom-copyright">p6e oauth2. github https://github.com/lidashuang1996</p>
        </div>
        <div class="main-content">
            <div class="main-content-title">
                <p class="title">P6e Oauth2 登录</p>
                <p class="subtitle">Oauth2 授权码模式</p>
            </div>
            <div class="main-content-client">
                <div class="ico" id="client-ico"></div>
                <div class="name">
                    <span id="client-name"></span>
                </div>
            </div>
            <div class="main-content-input" id="account">
                <label id="account-title">
                    账号
                </label>
                <label>
                    <input name=""
                           type="text"
                           placeholder="请输入账号（邮箱/手机号）"
                           id="account-input"
                           value="15549562863"
                           onkeyup="confirm()"
                           onfocus="inputFocus('account')"
                           onblur="inputBlur('account')"/>
                </label>
            </div>
            <div class="main-content-input" id="password">
                <label id="password-title">
                    密码
                </label>
                <label>
                    <input name=""
                           type="password"
                           placeholder="请输入密码"
                           id="password-input"
                           value="123456"
                           onkeyup="confirm()"
                           onfocus="inputFocus('password')"
                           onblur="inputBlur('password')"/>
                </label>
            </div>
            <div class="main-content-error" id="error">账号不能为空</div>
            <div class="main-content-button" id="button">
                <button onclick="confirm('LOGIN')" id="button-box">
                    <span id="button-text1">登 录</span>
                    <svg id="button-svg" style="width: 48px; height: 48px; display: none;" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
						<path fill="#fff" d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50" transform="rotate(273.148 50 50)">
                            <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50" to="360 50 50" repeatCount="indefinite"></animateTransform>
                        </path>
					</svg>
                    <span id="button-text2" style="display: none;">登录中...</span>
                </button>
            </div>
            <div class="main-content-authorization">
                <button onclick="authorization()">
                    <span>确 认</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!--
http://127.0.0.1:9900/?client_id=1234567890&redirect_uri=http://127.0.0.1:10000&response_type=code&scope=all&state=3123
-->
<script type="text/javascript">
    /** 是否初始化 */
    let isInit = false;
    /** 是否登录 */
    let isLogin = false;
    /** 初始化的数据 */
    let initData = {};
    /** 参数 */
    const params = {};
    /** 基本的 URL 的参数 */
    const baseUrl = '';

    /**
     * 初始化信息方法
     */
    function init() {
        const search = window.location.search;
        if (search !== null && search !== undefined && search !== '') {
            const item = search.split('?');
            for (let i = 0; i < item.length; i++) {
                if (item[i] !== null && item[i] !== undefined && item[i] !== '') {
                    const ite = item[i].split('&');
                    for (let j = 0; j < ite.length; j++) {
                        if (ite[j] !== null && ite[j] !== undefined && ite[j] !== '') {
                            const it = ite[j].split('=');
                            if (it !== null && it !== undefined && it.length === 2) {
                                params[it[0]] = it[1];
                            }
                        }
                    }
                }
            }
        }
        // 验证凭证
        const data = getCache();
        auth(data == null ? null : data.accessToken);
    }

    /**
     * 认证的方法
     */
    function auth(auth) {
        let url = baseUrl + '/auth?';
        const data = {
            scope: params.scope,
            client_id: params.client_id,
            redirect_uri: params.redirect_uri,
            response_type: params.response_type
        };
        if (params.state !== null && params.state !== undefined) {
            data.state =  params.state;
        }
        for (const param in params) {
            url += param + '=' + encodeURIComponent(params[param]) + '&';
        }
        const headers = {};
        if (auth !== null && auth !== undefined) {
            headers['authentication'] = 'Bearer ' + auth;
        }
        $.ajax({
            type: 'GET',
            url: url.substring(0, url.length - 1),
            contentType: 'application/json',
            headers: headers,
            dataType: 'JSON',
            success: (res) => {
                if (res.code === 0) {
                    initData = res.data;
                    $('#login').css('display', 'block');
                    $('#client-name').text(res.data.name);
                    $('#client-ico').css('background-image', 'url(\'' + res.data.icon + '\')');
                    if (res.data.accessToken === null || res.data.accessToken === undefined) {
                        isInit = true;
                        $('.main-content-authorization').css('display', 'none');
                    } else {
                        $('.main-content-input').css('display', 'none');
                        $('.main-content-error').css('display', 'none');
                        $('.main-content-button').css('display', 'none');
                    }
                } else {
                    $('#prompt').text(res.message);
                    $('#prompt').css('display', 'block');
                }
            }, error: (e) => {
                console.log(e);
            }
        });
    }

    /**
     * 按键触发事件，以及确认事件
     */
    function confirm(e) {
        if (isLogin || !isInit) {
            return;
        }
        //在火狐下event会做为参数传进来，ie下会在window下
        const event = e || window.event;
        // e.which是火狐下获取keyCode的方式，ie下使用e.keyCode获取
        const keyCode = event.which || event.keyCode || (e === 'LOGIN' && 13);
        const account = document.getElementById('account-input').value;
        const password = document.getElementById('password-input').value;
        if (account.length === 0) {
            document.getElementById('error').innerText = '账号不能为空';
            document.getElementById('error').style.display = 'block';
            document.getElementById('button').style.marginTop = '20px';
            return;
        } else if (account.length < 5) {
            document.getElementById('error').innerText = '账号长度不能低于5位';
            document.getElementById('button').style.marginTop = '20px';
            document.getElementById('error').style.display = 'block';
            return;
        } else if (password.length === 0) {
            document.getElementById('error').innerText = '密码不能为空';
            document.getElementById('button').style.marginTop = '20px';
            document.getElementById('error').style.display = 'block';
            return;
        } else if (password.length < 6) {
            document.getElementById('error').innerText = '密码长度不能低于6位';
            document.getElementById('button').style.marginTop = '20px';
            document.getElementById('error').style.display = 'block';
            return;
        }
        document.getElementById('error').innerText = '';
        document.getElementById('button').style.marginTop = '40px';
        document.getElementById('error').style.display = 'none';
        if (keyCode === 13) {
            // 打开加载动画
            document.getElementById('button-text1').style.display = 'none';
            document.getElementById('button-text2').style.display = 'block';
            document.getElementById('button-svg').style.display = 'block';
            loginAjax({
                mark: initData.mark,
                voucher: initData.voucher,
                account: account,
                password: encryption(initData.publicKey, password)
            });
        }
    }
    
    /**
     * 授权
     */
    function authorization() {
        if (initData.responseType !== null
            && initData.responseType !== undefined
            && 'code' === initData.responseType.toLocaleLowerCase()) {
            window.location.href = initData.redirectUri + '?code=' + initData.code
                + ((initData.state === undefined || initData.state === null) ? '' : '&state=' + initData.state);
        } else {
            window.location.href = initData.redirectUri + '?access_token='
                + initData.accessToken + '&expires_in=' + initData.expiresIn
                + ((initData.state === undefined || initData.state === null) ? '' : '&state=' + initData.state);
        }
    }

    /**
     * 登陆的 ajax 请求
     */
    function loginAjax(data) {
        isLogin = true;
        $.ajax({
            type: 'POST',
            url: '/login/',
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'JSON',
            success: (res) => {
                isLogin = false;
                if (res.code === 0) {
                    console.log(res);
                    // 写入缓存
                    setCache(JSON.stringify({
                        accessToken: res.data.accessToken,
                        refreshToken: res.data.refreshToken,
                        tokenType: res.data.tokenType,
                        expiresIn: res.data.expiresIn
                    }));
                    if (res.data.responseType !== null
                        && res.data.responseType !== undefined
                        && 'code' === res.data.responseType.toLocaleLowerCase()) {
                        window.location.href = res.data.redirectUri + '?code=' + res.data.code
                            + ((res.data.state === undefined || res.data.state === null) ? '' : '&state=' + res.data.state);
                    } else {
                        window.location.href = res.data.redirectUri + '?access_token='
                            + res.data.accessToken + '&expires_in=' + res.data.expiresIn
                            + ((res.data.state === undefined || res.data.state === null) ? '' : '&state=' + res.data.state);
                    }
                } else {
                    document.getElementById('error').innerText = res.message;
                }
                // 关闭加载动画
                document.getElementById('button-text1').style.display = 'block';
                document.getElementById('button-text2').style.display = 'none';
                document.getElementById('button-svg').style.display = 'none';
            }, error: (e) => {
                isLogin = false;
                // 关闭加载动画
                document.getElementById('error').innerText = '网络异常，请稍后重试';
                document.getElementById('button-text1').style.display = 'block';
                document.getElementById('button-text2').style.display = 'none';
                document.getElementById('button-svg').style.display = 'none';
                console.log(e);
            }
        });
    }

    /**
     * 获取焦点事件
     */
    function inputFocus(name) {
        document.getElementById(name + '-title').style.color = 'rgb(60 129 228)';
        document.getElementById(name).style.borderBottom = '2px solid rgb(60 129 228)';
    }

    /**
     * 失去焦点事件
     */
    function inputBlur(name) {
        document.getElementById(name + '-title').style.color = '#262626';
        document.getElementById(name).style.borderBottom = '2px solid #262626';
    }

    /**
     * 加密
     */
    function encryption(a, b) {
        //使用公钥加密
        const encrypt = new JSEncrypt();
        encrypt.setPublicKey('-----BEGIN PUBLIC KEY-----' + a + '-----END PUBLIC KEY-----');
        return encrypt.encrypt(b);
    }

    /**
     * 缓存的相关的操作
     */
    function setCache(data) {
        setCookie('P6E_OAUTH2_AUTH_TOKEN', data, 1);
    }

    /**
     * 缓存的相关的操作
     */
    function getCache() {
        const data = getCookie('P6E_OAUTH2_AUTH_TOKEN');
        if (data !== null && data !== undefined) {
            return JSON.parse(data);
        } else {
            return null;
        }
    }

    /**
     * 写入缓存数据
     */
    function setCookie(name, value, hours){
        const d = new Date();
        d.setTime(d.getTime() + (hours * 3500 * 1000));
        const expires = d.toGMTString();
        document.cookie = name + '=' + value + ';expires=' + expires;
    }

    /**
     * 读取缓存数据
     */
    function getCookie(name){
        const reg = new RegExp('(^| )' + name + '=([^;]*)(;|$)');
        const arr = document.cookie.match(reg);
        if(arr !== undefined && arr !== null) {
            return unescape(arr[2]);
        } else {
            return null;
        }
    }

    $(function () {
        init();
    });
</script>
</body>
</html>
